<% content_for :head do %>
<%= javascript_include_tag 'hooks' %>
<% end %>
<h1 class="header va-reset"><%= image_tag 'icons/repository.png' %>Editing <%= current_repository.name %></h1>
<%- flash.each do |name, msg| -%>
	<%= content_tag :div, msg, :class => "flash-#{name}" %>
<%- end -%>
<div class="subnav-bar single">
	<ul>
		<li>
			<%= link_to 'General', admin_path %>
		</li>
		<li>
			<%= link_to 'Service Hooks', '', :class => 'selected' %>
		</li>
	</ul>
</div>
<div class="clear">&nbsp;</div>

<div id="service-hooks-header">Service Hooks</div>
<div id="service-hooks">
	<div class="service-list-div">
		<ul>
			<li class="current <%= service_active? current_repository.hooks.post_receive %>"><a href="#" class="hook_edit_toggle" id="postreceive_urls-toggle">Post-Receive URLs (<%= current_repository.hooks.post_receive ? current_repository.hooks.post_receive.options['urls'].length : '0' %>)</a></li>
			<% @hooks.each do |k, hook| -%>
				<% next if  hook.plugin_name == "post_receive" -%>
				<li class="<%= service_active? eval("current_repository.hooks.#{hook.plugin_name}") %>"><%= link_to hook.html_name, '#', :id => "#{hook.plugin_name}-toggle", :class => 'hook_edit_toggle' %></li>
			<% end -%>
		</ul>
	</div>
	<div class="service-arrows"></div>
	<div class="service-hook-div">
		<div id="postreceive_urls" class="hook">
			<div class="head">Post-Receive URLs</div>
			<% semantic_form_for current_repository.hooks || current_repository.hooks.new(:name => 'post_receive', :options => { 'urls' => [] }), :url => admin_hooks_post_path do |form| %>
				<% form.inputs do %>
					<%= form.input :name, :as => :hidden %>
					<% form.inputs :for => :urls do |u| %>
						<% if current_repository.hooks.post_receive %>
						<% current_repository.hooks.post_receive.options['urls'].each do |url| %>
						<%= u.input [], :label => "URL", :input_html => { :value => url }, :extra_html => (" " + link_to_function(image_tag('icons/delete.png'), 'remove_field(this)')) %>
						<% end %>
						<% end %>
						<%= u.input [], :label => "URL", :extra_html => (" " + link_to_function(image_tag('icons/plus-small.png'), 'add_field(this)')), :wrapper_html => { :class => 'add_url' } %>
					<% end %>
				<% end %>
				<% form.buttons do %>
					<%= form.commit_button :label => "Update Hook" %>
				<% end %>
			<% end %>
		</div>
		<div id="email" class="hook" style="display:none;">
			<div class="head">Email</div>
			<% semantic_form_for current_repository.hooks.email || current_repository.hooks.new(:name => 'email', :options => { 'emails' => [] }), :url => admin_hooks_email_path do |form| %>
				<% form.inputs do %>
					<%= form.input :name, :as => :hidden %>
					<% form.inputs :for => :emails do |u| %>
						<% if current_repository.hooks.email %>
						<% current_repository.hooks.email.options['emails'].each do |email| %>
						<%= u.input [], :label => "Email", :input_html => { :value => email }, :extra_html => (" " + link_to_function(image_tag('icons/delete.png'), 'remove_email(this)')) %>
						<% end %>
						<% end %>
						<%= u.input [], :label => "Email", :extra_html => (" " + link_to_function(image_tag('icons/plus-small.png'), 'add_email(this)')), :wrapper_html => { :class => 'add_email' } %>
					<% end %>
				<% end %>
				<% form.buttons do %>
					<%= form.commit_button :label => "Update Hook" %>
				<% end %>
			<% end %>
		</div>
		<% @hooks.each do |k, hook| -%>
		<% next if hook.plugin_name == "email" ||  hook.plugin_name == "post_receive" %>
		<div id="<%= hook.plugin_name %>" class="hook" style="display:none;">
			<div class="head"><%= hook.plugin_name.capitalize %></div>
			<% h = eval("current_repository.hooks.#{hook.plugin_name}_new") %>
			<% b = {} %>
			<% semantic_form_for h, :url => admin_hooks_path do |form| %>
				<% form.inputs do %>
					<%= form.input :name, :as => :hidden %>
					<% form.inputs :for => :options do |opts| %>
						<% h.hook_options_html.each do |k,v| %>
							<% b[k] = v if v[:as] && v[:as] == :boolean %>
							<% next if v[:as] == :boolean %>
							<%= opts.input k.to_sym, v %>
						<% end %>
						<% b.each do |k,v| %>
							<%= opts.input k.to_sym, v %>
						<% end %>
					<% end %>
					<%= form.input :active %>
				<% end %>
				<% form.buttons do %>
					<%= form.commit_button :label => "Update Hook" %>
				<% end %>
			<% end %>
		</div>
		<% end -%>		
	</div>
</div>